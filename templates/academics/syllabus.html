
{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="section-padding bg-white pb-5">
    <div class="container">
        <!-- Intro Text -->
        <div class="text-center mb-5" data-aos="fade-up">
            <span class="text-primary fw-bold text-uppercase letter-spacing-1 small">Curriculum & Resources</span>
            
            {% if intro_content %}
                <h1 class="display-5 fw-bold text-secondary mt-2 mb-4">{{ intro_content.title }}</h1>
                <div class="text-muted w-100 mx-auto text-center lh-lg fs-6 col-lg-10">
                    {{ intro_content.content|safe }}
                </div>
            {% else %}
                <h1 class="display-5 fw-bold text-secondary mt-2 mb-3">Our Levels & Books</h1>
                <p class="lead text-muted w-75 mx-auto">Browse books categorized by academy levels.</p>
            {% endif %}
        </div>

        <!-- NEW: BOOK ORDER FORM -->
        <div class="row justify-content-center" data-aos="fade-up">
            <div class="col-lg-8">
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                    <div class="card-header bg-secondary text-white p-4">
                        <h3 class="h5 mb-0 fw-bold"><i class="fas fa-book-reader me-2 text-accent"></i> Order Books Direct</h3>
                    </div>
                    <div class="card-body p-4 p-md-5 bg-light-mint">
                        <p class="text-muted small mb-4 border-start border-4 border-primary ps-3">
                            Please complete and submit the form below. We aim to have books ready for collection within <strong>one week</strong>. 
                            You can pay by <strong>cash or card</strong> when you collect.
                        </p>

                        <form method="post">
                            {% csrf_token %}
                            <div class="row g-3">
                                <!-- Student Details -->
                                <div class="col-md-8">
                                    <label class="form-label fw-bold small text-secondary">Student Full Name</label>
                                    {{ form.student_name }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-secondary">Class</label>
                                    {{ form.student_class }}
                                </div>

                                <!-- Parent Details -->
                                <div class="col-12">
                                    <label class="form-label fw-bold small text-secondary">Parent Full Name</label>
                                    {{ form.parent_name }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Mobile Number</label>
                                    {{ form.parent_mobile }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Email Address</label>
                                    {{ form.parent_email }}
                                </div>

                                <!-- Reason Logic -->
                                <div class="col-12">
                                    <label class="form-label fw-bold small text-secondary">Reason for Order</label>
                                    {{ form.reason }}
                                </div>
                                <div class="col-12">
                                    <!-- This field is hidden by default via JS -->
                                    {{ form.other_reason_details }}
                                </div>

                                <div class="col-12 mt-4">
                                    <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold shadow-sm">
                                        Submit Order Request
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2. LEVELS & BOOKS GRID -->
<section class="section-padding bg-white">
    <div class="container">
        <!-- CHANGED: Loop through 'levels' instead of 'subjects' -->
        {% for level in levels %}
        <div class="mb-5" data-aos="fade-up">
            <!-- Level Header -->
            <div class="d-flex align-items-center mb-4">
                <div class="bg-primary rounded-circle me-3" style="width: 10px; height: 10px;"></div>
                <!-- CHANGED: displaying level.name -->
                <h2 class="h3 fw-bold text-secondary mb-0">{{ level.name }}</h2>
            </div>
            
            {% if level.description %}
                <p class="text-muted mb-4 ms-4 ps-2 border-start border-2">{{ level.description }}</p>
            {% endif %}

            <!-- Books Grid -->
            <div class="row g-4">
                <!-- CHANGED: accessing level.books.all -->
                {% for book in level.books.all %}
                <div class="col-md-6 col-lg-3">
                    <div class="hover-card h-100 border-0 shadow-sm rounded-4 overflow-hidden d-flex flex-column">
                        
                        <!-- Book Cover -->
                        <div class="bg-light-mint position-relative d-flex align-items-center justify-content-center p-4" style="height: 240px;">
                            {% if book.cover_image %}
                            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="shadow-lg rounded-1" style="max-height: 180px; width: auto; max-width: 100%; transition: transform 0.3s;">
                            {% else %}
                            <div class="bg-white rounded-1 shadow-sm d-flex flex-column align-items-center justify-content-center text-center p-2" style="width: 120px; height: 160px; border-left: 4px solid var(--secondary);">
                                <i class="fas fa-book fa-2x text-light-mint mb-2"></i>
                                <small class="text-muted fw-bold" style="font-size: 0.6rem;">{{ book.title|truncatechars:15 }}</small>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Info Body -->
                        <div class="card-body p-4 d-flex flex-column">
                            <h5 class="h6 fw-bold text-secondary mb-1">{{ book.title }}</h5>
                            <small class="text-muted mb-3 d-block">By {{ book.author }}</small>
                            
                            <div class="mt-auto pt-3 border-top border-light d-grid gap-2">
                                
                                <!-- PDF Download -->
                                {% if book.pdf_file %}
                                <a href="{{ book.pdf_file.url }}" target="_blank" class="btn btn-outline-primary btn-sm rounded-pill fw-bold">
                                    <i class="fas fa-file-pdf me-1"></i> Download PDF
                                </a>
                                {% endif %}

                                <!-- Purchase Links -->
                                {% for link in book.purchase_links.all %}
                                <a href="{{ link.url }}" target="_blank" class="btn btn-primary btn-sm rounded-pill fw-bold shadow-sm">
                                    <i class="fas fa-shopping-cart me-1"></i> Buy on {{ link.vendor_name }}
                                </a>
                                {% endfor %}

                                {% if not book.pdf_file and not book.purchase_links.exists %}
                                <button class="btn btn-light btn-sm rounded-pill text-muted" disabled>
                                    <i class="fas fa-store-slash me-1"></i> Not Available
                                </button>
                                {% endif %}
                                
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-light border-0 shadow-sm text-center py-4">
                        <i class="fas fa-layer-group text-muted fa-2x mb-3 opacity-50"></i>
                        <p class="text-muted mb-0">No resources currently listed for {{ level.name }}.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-5">
            <div class="bg-light-mint d-inline-block p-5 rounded-circle mb-3">
                <i class="fas fa-book-open fa-3x text-primary opacity-50"></i>
            </div>
            <h4 class="h5 text-secondary">Curriculum Updating</h4>
            <p class="text-muted mt-2">Levels and materials will be available shortly.</p>
        </div>
        {% endfor %}
    </div>
</section>
<!-- JAVASCRIPT FOR TOGGLE LOGIC -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const reasonDropdown = document.getElementById('reasonDropdown');
        const otherField = document.getElementById('otherReasonField');

        function toggleOtherField() {
            if (reasonDropdown.value === 'other') {
                otherField.style.display = 'block';
                otherField.required = true;
            } else {
                otherField.style.display = 'none';
                otherField.required = false;
                otherField.value = ''; // Clear it if hidden
            }
        }

        if (reasonDropdown) {
            reasonDropdown.addEventListener('change', toggleOtherField);
            // Run once on load in case of form validation errors
            toggleOtherField();
        }
    });
</script>

{% endblock %}